# Multi-Factor Authentication (MFA) Implementation

## Task 4: Multi-Factor Authentication (MFA) - COMPLETED ✅

This document summarizes the implementation of Multi-Factor Authentication using TOTP (Time-based One-Time Password) for the Zero Trust Security Framework.

## Overview

The MFA implementation provides an additional layer of security by requiring users to verify their identity using a time-based one-time password (TOTP) generated by an authenticator app.

## Components Implemented

### Frontend Components

#### 1. MFASetup Component (`frontend/src/components/auth/MFASetup.jsx`)

**Purpose:** Guide users through the MFA setup process

**Features:**
- Step-by-step setup wizard
- QR code generation and display
- Manual secret code entry option
- Copy-to-clipboard functionality
- Authenticator app recommendations
- Important security notes
- Navigation to verification step

**User Flow:**
1. User navigates to MFA setup
2. Backend generates TOTP secret
3. QR code displayed for scanning
4. Manual code provided as backup
5. User scans QR code with authenticator app
6. User clicks "Continue to Verification"
7. Redirected to MFA verification page

**Authenticator Apps Supported:**
- Google Authenticator (iOS, Android)
- Microsoft Authenticator (iOS, Android)
- Authy (iOS, Android, Desktop)
- Any TOTP-compatible app

#### 2. MFAVerification Component (`frontend/src/components/auth/MFAVerification.jsx`)

**Purpose:** Verify TOTP codes during login or setup

**Features:**
- 6-digit code input with individual boxes
- Auto-focus next input on digit entry
- Auto-submit when all 6 digits entered
- Paste support for full code
- Backspace navigation between inputs
- Loading state during verification
- Error message display
- Account lockout warning (3 failed attempts)
- Support for both setup and login flows

**User Flow:**
1. User enters 6-digit code from authenticator app
2. Code auto-submits when complete
3. Backend verifies TOTP code
4. On success: Redirect to dashboard
5. On failure: Clear code and show error
6. After 3 failures: Account locked

**Input Features:**
- Numeric input only
- Single digit per box
- Auto-advance on entry
- Backspace to previous box
- Paste full 6-digit code
- Visual feedback on error

### Backend Implementation

#### Already Implemented in Task 2

The backend MFA functionality was implemented in Task 2 as part of the authentication service:

**auth_service.py Methods:**
- `setup_mfa(user_id)` - Generate TOTP secret and QR code URI
- `verify_mfa_code(user_id, code)` - Verify 6-digit TOTP code
- MFA secret encryption using AES-256
- Failed attempt tracking (3 attempts max)
- Account lockout on exceeded attempts

**auth_routes.py Endpoints:**
- `POST /api/auth/mfa/setup` - Initialize MFA setup
- `POST /api/auth/mfa/verify` - Verify TOTP code

## Security Features

### 1. TOTP (Time-based One-Time Password)

**Algorithm:** RFC 6238 compliant TOTP
**Time Step:** 30 seconds
**Code Length:** 6 digits
**Valid Window:** ±1 time step (allows for clock drift)

### 2. Secret Encryption

**Encryption:** AES-256
**Storage:** Encrypted secrets stored in Firestore
**Key Management:** Encryption key stored in environment variables

### 3. Failed Attempt Protection

**Max Attempts:** 3 failed MFA verifications
**Lockout Duration:** 30 minutes (configurable)
**Tracking:** Per-user failed attempt counter
**Reset:** Counter reset on successful verification

### 4. Account Security

**Email Alerts:** Security alerts sent on lockout (to be implemented with audit logger)
**Session Management:** MFA required before session creation
**Token Validation:** JWT tokens include MFA verification status

## API Integration

### Setup MFA

**Endpoint:** `POST /api/auth/mfa/setup`

**Request:**
```javascript
// Requires authentication (session cookie)
axios.post('/api/auth/mfa/setup', {}, { withCredentials: true })
```

**Response:**
```json
{
  "success": true,
  "secret": "BASE32_SECRET_KEY",
  "qrCodeUri": "otpauth://totp/Zero%20Trust%20Security:user@example.com?secret=SECRET&issuer=Zero%20Trust%20Security"
}
```

### Verify MFA Code

**Endpoint:** `POST /api/auth/mfa/verify`

**Request:**
```javascript
axios.post('/api/auth/mfa/verify', 
  { code: "123456" },
  { withCredentials: true }
)
```

**Response (Success):**
```json
{
  "success": true,
  "verified": true,
  "message": "MFA verification successful"
}
```

**Response (Failure):**
```json
{
  "success": false,
  "verified": false,
  "error": {
    "code": "MFA_INVALID_CODE",
    "message": "Invalid MFA code"
  }
}
```

**Response (Locked):**
```json
{
  "success": false,
  "error": {
    "code": "AUTH_ACCOUNT_LOCKED",
    "message": "Account locked due to failed MFA attempts"
  }
}
```

## User Experience

### Setup Flow

1. **Initiation:**
   - User navigates to `/mfa/setup`
   - Backend generates TOTP secret
   - QR code displayed

2. **Configuration:**
   - User opens authenticator app
   - Scans QR code OR enters manual code
   - App generates 6-digit codes

3. **Verification:**
   - User clicks "Continue to Verification"
   - Enters first code from app
   - Backend verifies and enables MFA

4. **Completion:**
   - Success message displayed
   - User redirected to dashboard
   - MFA now required for all logins

### Login Flow with MFA

1. **Initial Login:**
   - User enters email/password
   - Backend checks if MFA enabled

2. **MFA Challenge:**
   - If MFA enabled, redirect to `/mfa/verify`
   - User enters current 6-digit code
   - Backend verifies code

3. **Access Granted:**
   - On success, session created
   - User redirected to dashboard
   - On failure, error shown and code cleared

## QR Code Generation

**Library:** `qrcode` (npm package)

**Configuration:**
```javascript
QRCode.toDataURL(qrCodeUri, {
  width: 256,
  margin: 2,
  color: {
    dark: '#000000',
    light: '#FFFFFF'
  }
})
```

**URI Format:**
```
otpauth://totp/Zero%20Trust%20Security:user@example.com?secret=SECRET&issuer=Zero%20Trust%20Security
```

## Styling & Design

### MFASetup Component

**Layout:**
- Step-by-step wizard with numbered steps
- Large QR code display (256x256px)
- Manual code with copy button
- Important notes in yellow alert box
- Action buttons at bottom

**Colors:**
- Primary: Blue (blue-600)
- Warning: Yellow (yellow-50, yellow-400)
- Success: Green (for copy confirmation)

### MFAVerification Component

**Layout:**
- 6 individual input boxes
- Centered on screen
- Error messages at top
- Security warning at bottom

**Input Boxes:**
- Width: 48px (3rem)
- Height: 56px (3.5rem)
- Font size: 2xl (1.5rem)
- Centered text
- Border highlight on focus

## Testing

### Manual Testing

1. **Setup MFA:**
   ```bash
   # Start backend and frontend
   # Login to application
   # Navigate to /mfa/setup
   # Scan QR code with authenticator app
   # Verify code works
   ```

2. **Verify MFA:**
   ```bash
   # Enter 6-digit code from app
   # Test auto-submit
   # Test paste functionality
   # Test invalid code
   # Test expired code
   ```

3. **Failed Attempts:**
   ```bash
   # Enter wrong code 3 times
   # Verify account locked
   # Wait 30 minutes or reset in database
   ```

### Test Scenarios

**Valid Code:**
```
Code: 123456 (from authenticator app)
Expected: Success, redirect to dashboard
```

**Invalid Code:**
```
Code: 000000
Expected: Error message, code cleared
```

**Expired Code:**
```
Code: (old code from 1 minute ago)
Expected: Error message
```

**Account Lockout:**
```
Attempts: 3 failed verifications
Expected: Account locked for 30 minutes
```

## Dependencies

### Frontend

**New Dependencies:**
- `qrcode` (^1.5.3) - QR code generation

**Existing Dependencies:**
- `react` - UI framework
- `react-router-dom` - Routing
- `axios` - HTTP client

### Backend

**Existing Dependencies:**
- `pyotp` (2.9.0) - TOTP generation and verification
- `cryptography` (41.0.7) - AES-256 encryption
- `firebase-admin` - Firestore storage

## Configuration

### Environment Variables

**Backend (.env):**
```bash
# MFA Configuration
MFA_LOCKOUT_ATTEMPTS=3
LOCKOUT_DURATION_MINUTES=30
ENCRYPTION_KEY=your_encryption_key_here
```

**Frontend (.env):**
```bash
REACT_APP_API_URL=http://localhost:5000/api
```

## Database Schema

### User Document (Firestore)

```javascript
{
  userId: "firebase_uid",
  email: "user@example.com",
  mfaEnabled: false,  // Set to true after first successful verification
  mfaSecret: "encrypted_base32_secret",  // AES-256 encrypted
  mfaFailedAttempts: 0,  // Counter for failed verifications
  lockoutUntil: null,  // Timestamp when lockout expires
  // ... other user fields
}
```

## Integration with Access Requests

MFA can be required for access requests based on policy evaluation:

**Policy Decision:**
```python
if confidence_score >= 50 and confidence_score < 90:
    decision = "granted_with_mfa"  # Require MFA verification
```

**Flow:**
1. User submits access request
2. Policy engine evaluates request
3. If decision is "granted_with_mfa"
4. User redirected to MFA verification
5. After successful MFA, access granted

## Requirements Satisfied

This implementation satisfies the following requirements:

✅ **Requirement 2.1:** TOTP-based MFA implementation  
✅ **Requirement 2.2:** QR code generation for easy setup  
✅ **Requirement 2.3:** 6-digit code verification  
✅ **Requirement 2.4:** MFA secret encryption (AES-256)  
✅ **Requirement 2.5:** Account lockout after 3 failed attempts  
✅ pyotp library installed and configured  
✅ MFA setup endpoint implemented  
✅ MFA verification endpoint implemented  
✅ MFA UI components created  
✅ Integration with access request flow (ready for Task 9)  

## Future Enhancements

### Planned Improvements

1. **Backup Codes:**
   - Generate one-time backup codes during setup
   - Allow recovery if authenticator lost

2. **Multiple Devices:**
   - Support multiple authenticator devices
   - Device management interface

3. **Biometric Authentication:**
   - WebAuthn/FIDO2 support
   - Fingerprint/Face ID on mobile

4. **SMS Backup:**
   - SMS code as fallback option
   - Phone number verification

5. **Remember Device:**
   - Trust device for 30 days
   - Skip MFA on trusted devices

6. **Admin Override:**
   - Admin can disable MFA for locked accounts
   - Emergency access procedures

## Troubleshooting

### QR Code Not Displaying

**Issue:** QR code doesn't appear
**Solution:**
- Check browser console for errors
- Verify `qrcode` package installed
- Check API response contains `qrCodeUri`

### Code Not Accepted

**Issue:** Valid code shows as invalid
**Solution:**
- Check device time is synchronized
- Verify TOTP time step (30 seconds)
- Check valid window setting (±1 step)

### Account Locked

**Issue:** User locked out after failed attempts
**Solution:**
- Wait 30 minutes for auto-unlock
- Admin can reset in Firestore:
  ```javascript
  db.collection('users').doc(userId).update({
    mfaFailedAttempts: 0,
    lockoutUntil: null
  })
  ```

### Secret Not Encrypted

**Issue:** MFA secret stored in plain text
**Solution:**
- Set `ENCRYPTION_KEY` in environment variables
- Restart backend server
- Re-setup MFA for affected users

## Security Best Practices

1. **Encryption Key Management:**
   - Store encryption key securely
   - Rotate keys periodically
   - Use different keys for dev/prod

2. **Rate Limiting:**
   - Limit MFA verification attempts
   - Implement exponential backoff
   - Monitor for brute force attacks

3. **Audit Logging:**
   - Log all MFA setup events
   - Log failed verification attempts
   - Alert on suspicious patterns

4. **User Education:**
   - Provide clear setup instructions
   - Warn about losing authenticator access
   - Offer backup code generation

5. **Recovery Process:**
   - Implement secure account recovery
   - Require identity verification
   - Document recovery procedures

## Next Steps

With MFA implementation complete, the next tasks will integrate this functionality:

- **Task 5:** Context Providers (AuthContext will track MFA status)
- **Task 6:** Protected Routes (MFA-required routes)
- **Task 7:** Policy Engine (MFA requirement based on confidence score)
- **Task 9:** Access Requests (MFA challenge for medium-confidence requests)

## Additional Resources

- [RFC 6238 - TOTP Specification](https://tools.ietf.org/html/rfc6238)
- [pyotp Documentation](https://pyauth.github.io/pyotp/)
- [QRCode.js Documentation](https://github.com/soldair/node-qrcode)
- [OWASP MFA Guidelines](https://cheatsheetseries.owasp.org/cheatsheets/Multifactor_Authentication_Cheat_Sheet.html)
